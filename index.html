<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Symulator stosu kart</title>
  <style>
    :root{
      --bg:#0f1724; --card-bg:#0b1220; --fg:#e6eef8; --muted:#9aa8bf; --accent:#8bd5ff;
    }
    [data-theme='light']{ --bg:#f6f8fb; --card-bg:#ffffff; --fg:#071029; --muted:#58677a; --accent:#0066cc }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Arial;background:radial-gradient(circle at 10% 10%, rgba(139,213,255,0.06), transparent 8%), radial-gradient(circle at 90% 90%, rgba(0,102,204,0.04), transparent 12%), var(--bg);color:var(--fg)}
    .app{min-height:100vh;display:flex;flex-direction:column;gap:20px;align-items:center;justify-content:center;padding:36px}

    header{width:100%;max-width:1100px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:20px}

    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--fg);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    input[type=file]{display:none}

    main{width:100%;max-width:1100px;display:grid;grid-template-columns:1fr 360px;gap:24px}

    /* Stos kart */
    .stack-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .stage{width:420px;height:560px;display:flex;align-items:center;justify-content:center;perspective:1200px}

    .card{width:320px;height:480px;border-radius:16px;position:relative;transform-style:preserve-3d;transition:transform 600ms cubic-bezier(.2,.9,.2,1);cursor:pointer;box-shadow:0 10px 30px rgba(2,6,23,0.6), 0 2px 6px rgba(2,6,23,0.4);}
    .card.front{transform:rotateX(0deg)}
    .card.flipped{transform:rotateY(180deg)}

    .card-face{position:absolute;inset:0;border-radius:16px;backface-visibility:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
    .card-back{background:linear-gradient(180deg,var(--card-bg),rgba(0,0,0,0.05));box-shadow:inset 0 -30px 60px rgba(0,0,0,0.18);}
    .card-front{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.03));transform:rotateY(180deg);overflow:auto}

    .card .title{font-weight:700;margin-bottom:8px}
    .card .content{font-size:18px;line-height:1.4;color:var(--fg);text-align:center}
    .count{font-size:14px;color:var(--muted)}

    /* stack pile visual */
    .pile{position:relative;width:120px;height:170px}
    .pile .slice{position:absolute;left:0;right:0;height:100%;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.015),rgba(0,0,0,0.03));box-shadow:0 6px 18px rgba(2,6,23,0.6);transform-origin:center;}

    /* bloom effect */
    .bloom{position:absolute;pointer-events:none;inset:0;border-radius:24px;mix-blend-mode:screen;filter:blur(28px) saturate(140%);opacity:0.22}
    .bloom::before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 30% 20%,var(--accent),transparent 30%), radial-gradient(circle at 80% 80%,rgba(139,213,255,0.6),transparent 30%)}

    /* small panel */
    .panel{background:var(--card-bg);border-radius:12px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.03)}

    .list{display:flex;flex-direction:column;gap:8px}

    .muted{color:var(--muted)}

    /* animations for removing card */
    .gone{animation:flyAway 700ms ease forwards}
    @keyframes flyAway{to{transform:translateY(-1200px) rotateZ(30deg) scale(0.4);opacity:0}}

    footer{width:100%;max-width:1100px;display:flex;justify-content:space-between;color:var(--muted);font-size:13px}

    /* responsive */
    @media (max-width:900px){main{grid-template-columns:1fr} .stage{width:92vw;height:64vw}} 
  </style>
</head>
<body data-theme="dark">
  <div class="app">
    <header>
      <h1>Symulator stosu kart</h1>
      <div class="controls">
        <label class="btn">
          Importuj plik .txt
          <input id="fileInput" type="file" accept=".txt" />
        </label>
        <button id="clearBtn" class="btn">Wyczyść stos</button>
        <button id="toggleTheme" class="btn">Tryb jasny</button>
      </div>
    </header>

    <main>
      <section class="stack-wrap">
        <div class="stage panel" id="stage">
          <div class="bloom" aria-hidden></div>
          <!-- tutaj wstawiana karta -->
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="pile panel">
            <div id="pileSlices"></div>
          </div>
          <div style="text-align:left">
            <div class="count" id="count">Kartek: 0</div>
            <div class="muted" id="topPreview">Brak kart</div>
          </div>
        </div>
      </section>

      <aside class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Ustawienia</strong>
        </div>
        <div class="list">
          <div class="muted">Kliknij kartę: pierwsze kliknięcie - odwrócenie, drugie - usuń i pokaż następną.</div>
          <button id="shuffleBtn" class="btn">Przetasuj stos</button>
          <button id="exportBtn" class="btn">Eksportuj stos (.txt)</button>
        </div>
      </aside>
    </main>

    <footer>
      <div>Przechowywane w <strong>localStorage</strong></div>
      <div class="muted">Plik z liniami: każda linia = jedna karta</div>
    </footer>
  </div>

  <script>
    // Klucz w localStorage
    const STORAGE_KEY = 'cardStack_v1';
    const THEME_KEY = 'cardTheme_v1';

    const fileInput = document.getElementById('fileInput');
    const stage = document.getElementById('stage');
    const countEl = document.getElementById('count');
    const topPreview = document.getElementById('topPreview');
    const pileSlices = document.getElementById('pileSlices');

    let stack = loadStack();

    // Restore theme
    const body = document.body;
    const toggleThemeBtn = document.getElementById('toggleTheme');
    const storedTheme = localStorage.getItem(THEME_KEY) || 'dark';
    body.setAttribute('data-theme', storedTheme);
    toggleThemeBtn.textContent = storedTheme === 'light' ? 'Tryb ciemny' : 'Tryb jasny';

    toggleThemeBtn.addEventListener('click', ()=>{
      const next = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      body.setAttribute('data-theme', next);
      localStorage.setItem(THEME_KEY, next);
      toggleThemeBtn.textContent = next === 'light' ? 'Tryb ciemny' : 'Tryb jasny';
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{ if(confirm('Na pewno wyczyścić stos?')){stack=[];saveStack();render();}});
    document.getElementById('shuffleBtn').addEventListener('click', ()=>{shuffle(stack);saveStack();render();});
    document.getElementById('exportBtn').addEventListener('click', exportStack);

    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if(lines.length===0){alert('Plik nie zawiera żadnych linii.');return}
        shuffle(lines);
        // Now prepend new lines into existing stack
        stack = lines.concat(stack);
        saveStack();
        render();
      }catch(err){console.error(err);alert('Błąd odczytu pliku.');}
      fileInput.value = null;
    });

    function loadStack(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      }catch(e){console.error(e);return []}
    }
    function saveStack(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(stack));
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
    }

    function render(){
      stage.querySelectorAll('.card').forEach(n=>n.remove());
      countEl.textContent = 'Kartek: ' + stack.length;
      if(stack.length===0){
        topPreview.textContent = 'Brak kart';
        renderPile(0);
        const info = document.createElement('div');
        info.className='muted';
        info.textContent='Zaimportuj plik .txt aby dodać karty. Każda linia to jedna karta.';
        stage.appendChild(info);
        return;
      }
      topPreview.textContent = stack[0].slice(0,40) + (stack[0].length>40? '…':'');
      renderPile(stack.length);

      // create visual card with stacked depth
      const card = createCard(stack[0]);
      stage.appendChild(card);
    }

    function renderPile(n){
      pileSlices.innerHTML='';
      const slices = Math.min(n,8);
      for(let i=0;i<slices;i++){
        const s = document.createElement('div');
        s.className='slice';
        s.style.top = (i*2)+'px';
        s.style.left = (i*2)+'px';
        s.style.right = (i*2)+'px';
        s.style.transform = `rotate(${(i-3)*1.5}deg) translateZ(${i}px)`;
        s.style.opacity = 0.9 - i*0.08;
        pileSlices.appendChild(s);
      }
    }

    function createCard(text){
      const el = document.createElement('div');
      el.className='card front panel';

      // back face (design)
      const back = document.createElement('div'); back.className='card-face card-back';
      const logo = document.createElement('div'); logo.className='title'; logo.textContent='KARTA AKCJI';
      const sub = document.createElement('div'); sub.className='muted'; sub.textContent='Kliknij, aby odsłonić';
      back.appendChild(logo); back.appendChild(sub);

      // front face (content)
      const front = document.createElement('div'); front.className='card-face card-front';
      const title = document.createElement('div'); title.className='title'; title.textContent='Treść karty';
      const content = document.createElement('div'); content.className='content'; content.textContent = text;
      front.appendChild(title); front.appendChild(content);

      el.appendChild(back); el.appendChild(front);

      let flipped = false;
      el.addEventListener('click', ()=>{
        if(!flipped){
          flipped = true; el.classList.add('flipped');
        } else {
          // remove top card
          el.classList.add('gone');
          // small delay to let animation play
          setTimeout(()=>{
            stack.shift(); saveStack(); render();
          }, 300);
        }
      });

      // keyboard: space to flip/remove
      el.tabIndex = 0;
      el.addEventListener('keydown', (e)=>{
        if(e.key === ' ' || e.key === 'Enter') { e.preventDefault(); el.click(); }
      });

      return el;
    }

    function exportStack(){
      if(stack.length===0){alert('Brak kart do eksportu.');return}
      const blob = new Blob([stack.join('\n')], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'cards_export.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // initial render
    render();
  </script>
</body>
</html>
